<!DOCTYPE html >
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>CT MODULE</title>
    <style>
        body {
        //background-image: url("Common/img/logo.png");
            background-size: 180px;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: right 40px top 30px;
            font-family: Arial;
        }
        #app_header {
            padding: 10px;
            padding-left: 40px;
            padding-top: 15px;
            padding-bottom: 0px;
            height:80px;
            width:400px;
            text-align: center;
        }
        #app_title {
            width:400px;
            text-align: center;
            font-family: "Arial Black",Arial,Helvetica,sans-serif;
            font-size:32px;
            color: #007dc0;
            margin-bottom; 20px;
        }
        #app_menu {
            width:400px;
            text-align: center;
            font-family: Arial,Helvetica,sans-serif;
        }
        #page_title {
            width:400px;
            text-align: center;
            font-family: "Arial Black",Arial,Helvetica,sans-serif;
            font-size:28px;
            color: #cfcfcf;
        }
        #mesm_content {
            padding: 30px;
            padding-top: 40px;
        }
        #__button0, #__button1, #__button2 {
            margin-top:10px;
            margin-left:5px;
            margin-right:5px;
        }
        #MatrixT, #MatrixB {
            margin:10px auto;
        }
        #__cell2, #__cell3, #__cell4, #__cell5, #__cell6 {
            text-align:center;
        }
        #__cell0 {
            text-align:right;
        }
        #PlantsList {
            margin-left: 20px;
        }
    </style>

    <script id="sap-ui-bootstrap"
            src="/sapui5/resources/sap-ui-core.js"
            data-sap-ui-theme="sap_goldreflection"
            data-sap-ui-libs="sap.ui.core,sap.ui.commons,sap.ui.table,sap.ui.ux3"
            data-sap-ui-language="en" >
    </script>
    <script type="text/javascript" src="Common/js/default.js"></script>

    <script type="text/javascript" id="app-init">
        // ******************************************************************************************************************************************************************
        // Get Core SAP UI5
        var oCore = sap.ui.getCore();
        // Initialize screen
        var nrRows = 13;
        var selectedIndex =  -1;
        // ********************************************************************************************************************
        // initialize access
        var level2Access = "";
        var plant2Access = "";
        // Initialize screen
        var selectedPlant = 0;
        var recordID = "";
        var tableCreated = 0;

        // ************************************	MENU		******************************************************************************************************************************

        var timestamp = new Date().getTime();

        var jsFile=document.createElement('script');
        jsFile.setAttribute("type","text/javascript");
        jsFile.setAttribute("src", "Common/js/menu.js?ts="+timestamp);
        //jsFile.setAttribute("src", "Common/js/menu.js");
        document.getElementsByTagName("head")[0].appendChild(jsFile);

        // ****************************************************************************************************************************************************
        function onLoadPage() {

            //alert(plant2Access);
            updatePlants(plant2Access);
            oMatrixT.placeAt('mesm_content');
        }

        // ****************************************************************************************************************************************************
        var oMatrixT = new sap.ui.commons.layout.MatrixLayout({
            id : 'MatrixT',
            layoutFixed : true,
            width: '1200px',
            columns : 1,
            widths : ['1200px']
        });

        var oLabelPlants = new sap.ui.commons.Label({
            id : 'L-Plants',
            visible : true,
            text : 'SELECTED PLANT ' });

        var oDropdownBoxPlants = new sap.ui.commons.DropdownBox({
            id : "PlantsList",
            tooltip : 'Active Plants',
            editable : true,
            width : '230px',
            change: function(oEvent){
                //alert(oEvent.oSource.getSelectedItemId());
                var endplant = oEvent.oSource.getSelectedItemId();
                var result =  endplant.substring(6,endplant.length);
                selectedPlant = result;
                // alert(result);
                updateTableConnDiagnostics();
            }
        });

        var oLayout = new sap.ui.layout.HorizontalLayout("LayoutPlants", {
            content: [oLabelPlants, oDropdownBoxPlants]
        });

        // oMatrixT.createRow( oLayout );
        // ****************************************************************************************************************************************************
        function createTableConnDiagnostics() {
            // Bind the table rows to this model
            var timestamp = new Date().getTime();
            //alert("Create: " + oDropdownBoxPlants.getSelectedKey());
            oModel.loadData("/XMII/Illuminator?QueryTemplate=OneHDMIIOwensboro/DIAGNOSTICS/QUERIES/get_ConnDiag&Param.1="+plant2Access+"&ts="+timestamp+"&Content-Type=text/xml","",false);
            // alert(oModel.getXML());
            createColumnsConnDiagnostics();
            oTable.setModel(oModel);
            oTable.bindRows("/Rowset/Row");
        };

        // ****************************************************************************************************************************************************
        function updateTableConnDiagnostics() {
            oTable.clearSelection();
            var timestamp = new Date().getTime();
            //alert("Update: " + oDropdownBoxPlants.getSelectedKey());
            oModel.loadData("/XMII/Illuminator?QueryTemplate=OneHDMIIOwensboro/DIAGNOSTICS/QUERIES/get_ConnDiag&Param.1="+plant2Access+"&ts="+timestamp+"&Content-Type=text/xml","",false);
            oTable.getModel().refresh(true);
        };
        // ****************************************************************************************************************************************************
        function createColumnsConnDiagnostics() {
            //Define the columns and the control templates to be used
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.ui.commons.Label({text: "WORK CENTER NAME"}),
                template: new sap.ui.commons.TextView().bindProperty("text", "unitName"),
                sortProperty: "unitName",
                filterProperty: "unitName",
                width: "150px"
            }));
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.ui.commons.Label({text: "SRV STATUS"}),
                template: new sap.ui.commons.Image().bindProperty("src", "stats"),
                width: "75px",
                hAlign: "Center"
            }));
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.ui.commons.Label({text: "PCO STATUS"}),
                template: new sap.ui.commons.Image().bindProperty("src", "agentStats"),
                width: "75px",
                hAlign: "Center"
            }));
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.ui.commons.Label({text: "OPC STATUS"}),
                template: new sap.ui.commons.Image().bindProperty("src", "opcStats"),
                width: "75px",
                hAlign: "Center"
            }));
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.ui.commons.Label({text: "PLC STATUS"}),
                template: new sap.ui.commons.Image().bindProperty("src", "plcStats"),
                width: "75px",
                hAlign: "Center"
            }));
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.ui.commons.Label({text: "LAST MESSSAGE TYPE"}),
                template: new sap.ui.commons.TextView().bindProperty("text", "notifTransactionType"),
                sortProperty: "notifTransactionType",
                filterProperty: "notifTransactionType",
                width: "125px"
            }));
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.ui.commons.Label({text: "TIMESTAMP"}),
                template: new sap.ui.commons.TextView().bindProperty("text", "CreatedOn"),
                sortProperty: "CreatedOn",
                filterProperty: "CreatedOn",
                width: "125px"
            }));
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.ui.commons.Label({text: "MESSAGES QTY [24H]"}),
                template: new sap.ui.commons.TextView().bindProperty("text", "LAST24H"),
                sortProperty: "",
                filterProperty: "",
                width: "125px"
            }));
        };

        // ******************************************************************************************************************************************************************
        //Create an instance of the table control
        var oTable = new sap.ui.table.Table({
            visibleRowCount: nrRows,
            visibleRowCountMode: sap.ui.table.VisibleRowCountMode.Interactive,
            firstVisibleRow: 0,
            width: "1200px",
            selectionBehavior: sap.ui.table.SelectionBehavior.Row,
            selectionMode: sap.ui.table.SelectionMode.Single
        });

        // ******************************************************************************************************************************************************************
        oTable.attachRowSelectionChange(function(oEvent) {
            // Retrieve the selected row
            var selIndex = oTable.getSelectedIndex();
            selectedIndex = selIndex;
            if (selIndex  >= 0) {
                // Retrieve the selected row
                var selectedRow = oTable.getRows()[selIndex];
                // sap.ui.commons.MessageBox.alert(selectedRow);
                var selectedRowContext = oEvent.getParameter("rowContext");
                recordID = oModel.getProperty("recordID", selectedRowContext);
                stopTimer();
            }
            else {
                selectedIndex =  -1;
                recordID = "";
                startTimer();
                // alert ("No Selection ..");
            }
        });

        var oModel =  new sap.ui.model.xml.XMLModel();

        //Bring the table onto the UI
        oMatrixT.createRow(oTable);

        // ******************************************************************************************************************************************************************
        function updatePlants(idPlant) {
            var timestamp = new Date().getTime();
            getData("/XMII/Illuminator?QueryTemplate=OneHDMIIOwensboro/PLANTS/TRANSACTIONS/getActivePlants_xAcute&Param.1="+idPlant+"&ts="+timestamp+"&Content-Type=text/xml", parseJsonPlantsList);
            function parseJsonPlantsList(jsondata){
                oDropdownBoxPlants.destroyItems();

                for (var i=0; i<jsondata.length; i++){
                    item_key = jsondata[i]['PLANT'];
                    item_text = jsondata[i]['DESC'];
                    oItem = new sap.ui.core.ListItem({
                        key : item_key,
                        text : item_text });
                    oDropdownBoxPlants.addItem(oItem);
                }
                oDropdownBoxPlants.setSelectedKey(idPlant);
                // alert(oDropdownBoxPlants.getSelectedKey());
                if(tableCreated == 0) {
                    createTableConnDiagnostics();
                    tableCreated = 1;
                }
                else{
                    updateTableConnDiagnostics();
                }
            }
        }
        // ******************************************************************************************************************************************************************
        var timer_is_on = 0;
        var timerVar = setInterval(function(){ updateTableConnDiagnostics(); }, 25000);

        function startTimer() {
            if (timerVar) {
                clearInterval(timerVar);
                timerVar = setInterval(function(){ updateTableConnDiagnostics(); }, 25000);
            }
        }

        function stopTimer() {
            clearInterval(timerVar);
            timer_is_on = 0;
        }
        // ******************************************************************************************************************************************************************
    </script>
</head>

<body onLoad="roleSecurity()">

<input id="user_roles" type="hidden" value="{IllumLoginRoles}" style="display:block;width:1000px;" readonly />
<input id="user_role" type="hidden" value="{ROLE}" style="display:block;width:1000px;" readonly />
<input id="user_name" type="hidden" value="{IllumLoginName}" style="display: block;width:1000px;" readonly />
<input id="user_height" type="hidden" value="{HEIGHT}" style="display: block;width:100px;" readonly />
<input id="user_address" type="hidden" value="{Machine}" style="display:block;width:1000px;" readonly />
<div id="app_header">
    <div id="app_title">CORE TRACEABILITY</div>
    <div id="app_menu"></div>
    <div id="page_title">DIAGNOSTICS</div>
</div>
<div id="mesm_content" ></div>
</body>
</html>